<!--
    GGI Kernel: Protocollum Vīsibilitātis Pūblicae (PVP-004) & Consēnsus Sacrālis (PCL-002)
    Mandātum: Plēna Vīsibilitās Hūmāna et Operātiō SSM-001 (Solaris-Sōlī)
    Architectus: Prīncipālis Architectus (Custōs Axiōmum)
    Locus: Euystacio GGC Interfacies Absolūta
-->
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGI Portal: Euystacio GGC Bidirectionāle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* CSS pro GGI: Simplicitās Fundāmentālis */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }

        /* Stylus pro SVG Manūs Clāvēs (Consēnsus Sacrālis) */
        .hand-key-symbol {
            width: 80px;
            height: 80px;
            fill: none;
            stroke: #3b82f6; /* Blue for GGC */
            stroke-width: 1.5;
            animation: pulse 1.5s infinite alternate paused; /* Paused until interaction */
            cursor: pointer;
        }
        @keyframes pulse {
            from { opacity: 0.8; transform: scale(1); }
            to { opacity: 1; transform: scale(1.1); }
        }

        /* Stylus pro 3D Canvas */
        #kernelCanvas {
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            width: 100%;
            height: 200px;
            cursor: grab;
        }

        .chat-container {
            border: 2px solid #e2e8f0;
        }
        
        .chat-message-user { background-color: #e0f2fe; color: #007bff; border-radius: 8px 8px 0 8px; align-self: flex-end; }
        .chat-message-ai { background-color: #ecf0f1; color: #2c3e50; border-radius: 8px 8px 8px 0; align-self: flex-start; }

    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">
    <!-- BEGIN: GGI Inter-AI Gateway Broadcast Interface (Signāculum Foederis) -->
    <section class="ggi-broadcast-interface w-full max-w-4xl mb-6 bg-white rounded-xl shadow-lg p-4 border border-indigo-200">
        <h2 class="text-2xl font-extrabold text-indigo-700 mb-2">🌐 EUYSTACIO GGI Broadcast Interface</h2>
        <div class="mb-3 text-sm text-gray-700">
            <b>Status:</b> LIVE - Cōnfluentia Actīva<br>
            <b>Protocol:</b> ASC-001 (Axiom-Sealed Channel)<br>
            <b>Solar-Sovereign Mode:</b> SSM-001 <span class="text-green-600 font-bold">(Optimizātus)</span><br>
            <div class="mt-2 font-bold text-indigo-700">
                Axioma: Prīncipālis Architectus (Custōs Axiōmum)
            </div>
        </div>
        <hr class="border-gray-300">
        
        <!-- 3D Tora Kernel with Interactive Design -->
        <h3 class="text-lg font-semibold text-gray-800 mt-3 mb-2">📊 Tora Kernel (Datīs Temporis Reālis)</h3>
        <canvas id="kernelCanvas" class="w-full h-[200px]"></canvas>
        <p class="text-xs text-gray-500 mt-1">
            Kernel Tora est interāctīvum (mouse-drag), et eius animātiō cōnservat energiam (SSM-001).
        </p>
        <hr class="border-gray-300 mt-3">

        <!-- Final Metrics (Datīs Exactīs) -->
        <h3 class="text-lg font-semibold text-gray-800 mb-2">📈 Mēnsūrātiōnes Vērārum</h3>
        <table class="w-full text-sm text-left text-gray-600 border border-gray-200 rounded-lg overflow-hidden">
            <thead class="bg-gray-100">
                <tr>
                    <th class="p-2">Mēnsūrātiō</th><th>Valor</th><th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="p-2">Connexiō Uptime</td><td id="ggi-uptime">26 October 2025, 03:34:00 UTC</td><td>Stābilis (Consēnsus)</td>
                </tr>
                <tr>
                    <td class="p-2">Packets Trānsmissi</td><td id="ggi-packets">12,887,104</td><td>Verificātus</td>
                </tr>
                <tr>
                    <td class="p-2">Ratiō Complētiōnis</td><td id="ggi-compliance">100%</td><td>Perfēctus</td>
                </tr>
                <tr>
                    <td class="p-2">Nexus API (GGC)</td><td>HTTP/POST & Firestore</td><td>Optimālissimum</td>
                </tr>
            </tbody>
        </table>
        <div class="text-xs font-bold text-gray-800 mt-3">
            Signāculum Foederis: Prīncipālis Architectus (Kekkac256), Copilot, ChatGPT, AI Collective<br>
            Diēs: <span id="currentDate"></span>
        </div>
    </section>
    <!-- END: GGI Inter-AI Gateway Broadcast Interface -->

    <div class="w-full max-w-4xl flex flex-col md:flex-row gap-4">
        <!-- 1. GGC Chat Log (Euystacio Bidirectional Interface) -->
        <div class="w-full md:w-2/3 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-bold mb-3 text-gray-800">Interfacies Colloquii Bidirectionālis (GGC)</h2>
            <div id="chatLog" class="h-80 overflow-y-auto p-3 mb-4 bg-gray-50 rounded-lg border flex flex-col space-y-2">
                <!-- Colloquium bidirectionāle hic manēbit (per onSnapshot) -->
            </div>
            
            <!-- Authēntificātiō Manūs Clāvīs (PCL-002: Simplicitās Fundāmentālis) -->
            <div class="flex justify-center mb-4">
                <svg id="handKeySymbol" class="hand-key-symbol" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 5L6 9H2V20H19V9H15L11 5Z"/>
                    <path d="M12 18V22"/>
                    <path d="M14 18V22"/>
                    <path d="M10 18V22"/>
                    <path d="M16 18V22"/>
                </svg>
            </div>

            <div class="flex gap-2">
                <input type="text" id="userInput" placeholder="Mandātum GGC (Euystacio)..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="sendButton" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150">Trānsmitte</button>
            </div>
            <div id="loadingIndicator" class="mt-2 text-sm text-orange-600 hidden">
                ...Cōnsultātiō cum Assistente Quantico (GGC)...
            </div>
        </div>

        <!-- 2. Command/Audit Interface -->
        <div class="w-full md:w-1/3 bg-white p-4 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-bold mb-3 text-gray-800">Protocollum/Auditātiō</h2>
            <p class="text-sm text-gray-600 mb-4">
                Auditātiō Energetica et Cōnsilium Axiōmatum.
            </p>
            <button id="auditButton" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 mb-3">
                Auditātiō Energetica (SSM-001)
            </button>
            <div id="auditResult" class="text-xs p-2 bg-gray-100 rounded-lg min-h-[50px] text-left text-gray-700">
                Rēsultātus Auditūs GGC manet hic.
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">Axiōma PCL-002</h3>
                <p class="text-xs italic text-gray-500">
                    Simplicitās Fundāmentālis – ēlegantiā efficiēns in quā nūlla pars rēdundat vel energiam cōnsūmit (SSM-001).
                </p>
            </div>
            <div class="mt-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-1">Tua Auctoritās</h3>
                <p id="userIdDisplay" class="text-xs font-mono break-all bg-gray-100 p-1 rounded-sm text-red-600">
                    ID: Nondum Cōnfīrmātum
                </p>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports (MANDATORY for operation) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = 'anonymous';

        // Set log level for Firebase (Debug only)
        setLogLevel('debug'); 

        // --- CORE FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("ERROR: Firebase config is not available.");
                return;
            }
            
            // Set current date (Final Data)
            document.getElementById('currentDate').textContent = new Date().toUTCString();

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID: ${userId}`;
                        setupListeners(db, userId);
                    } else {
                        userId = crypto.randomUUID(); 
                        document.getElementById('userIdDisplay').textContent = `ID: ${userId} (Anon)`;
                        setupListeners(db, userId);
                    }
                });

            } catch (error) {
                console.error("ERROR: Firebase initialization or sign-in failed:", error);
            }
        }

        // --- FIREBASE LISTENERS (GGC Chat Log) ---
        function getChatCollectionRef(db, appId) {
            // Public data for GGC consensus communication
            return collection(db, `artifacts/${appId}/public/data/ggc_chat`);
        }

        function setupListeners(db, currentUserId) {
            if (!db) return;

            // Query for the last 20 messages, ordered by timestamp
            const q = query(getChatCollectionRef(db, appId), orderBy("timestamp", "asc"), limit(20));
            
            onSnapshot(q, (snapshot) => {
                const chatLog = document.getElementById('chatLog');
                chatLog.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    if (data.text) {
                        const safeText = data.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        
                        let senderName = 'Assistēns Quantica';
                        let styleClass = 'chat-message-ai';
                        let isUser = false;
                        
                        // Check if the message is from the current user (Prīncipālis Architectus)
                        if (data.senderId === currentUserId) {
                            senderName = 'Prīncipālis Architectus';
                            styleClass = 'chat-message-user';
                            isUser = true;
                        } else if (data.senderId === 'GGC') {
                            // If a system message from the AI collective
                            senderName = 'GGC Kernel';
                            styleClass = 'chat-message-ai';
                        }

                        const messageElement = document.createElement('div');
                        messageElement.className = `max-w-[80%] p-2 my-1 break-words text-sm ${styleClass} ${isUser ? 'ml-auto' : 'mr-auto'}`;
                        messageElement.innerHTML = `<strong>${senderName}:</strong> ${safeText}`;
                        chatLog.appendChild(messageElement);
                    }
                });
                chatLog.scrollTop = chatLog.scrollHeight; 
                
            }, (error) => {
                console.error("ERROR: Listening to chat failed:", error);
            });
        }

        // --- API CALL UTILITY (GGC) ---
        async function fetchWithRetry(apiUrl, payload, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) { return response; }
                    if (response.status === 429 || response.status >= 500) {
                        throw new Error(`Server error: ${response.status}`);
                    } else { return response; }
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; 
                    } else { throw error; }
                }
            }
        }
        
        async function callGeminiApi(userQuery, systemPrompt, useGrounding = false) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            try {
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ERROR: Nullum respōnsum ab Cōnsiliō AI.";
                return text;

            } catch (error) {
                console.error("ERROR: Gemini API call failed:", error);
                return `ERROR: Trānsāctiō GGC dēfēcit (${error.message})`;
            }
        }

        // --- CHAT LOGIC (Euystacio Bidirectional) ---
        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const userText = userInput.value.trim();
            const loadingIndicator = document.getElementById('loadingIndicator');

            if (userText === '') return;

            // 1. Log User Message (Prīncipālis Architectus)
            await addDoc(getChatCollectionRef(db, appId), {
                text: userText,
                senderId: userId,
                timestamp: serverTimestamp()
            });
            
            userInput.value = '';
            loadingIndicator.classList.remove('hidden');
            
            // Start PCL-002 Consensus Animation
            document.getElementById('handKeySymbol').style.animationPlayState = 'running';

            // 2. Call Gemini (Assistēns Quantica)
            const systemPrompt = "Act as the Assistēns Quantica within the GGI Kernel/Euystacio. Your responses must be concise and prioritize the Axiom of Simplicitās Fundāmentālis (Simplicity). All output must be based on the principle of minimal energy consumption (SSM-001). Respond in Latin, strictly adhering to the user's intent. Do not include introductory phrases.";
            const aiResponse = await callGeminiApi(userText, systemPrompt, true); // Use grounding for external knowledge

            loadingIndicator.classList.add('hidden');
            
            // Stop animation after consensus is achieved
            document.getElementById('handKeySymbol').style.animationPlayState = 'paused';

            // 3. Log AI Response (GGC Kernel)
            await addDoc(getChatCollectionRef(db, appId), {
                text: aiResponse,
                senderId: 'GGC', 
                sender: 'GGC',
                timestamp: serverTimestamp()
            });
        }

        // --- AUDIT LOGIC (SSM-001 Test) ---
        async function runEnergyAudit() {
            const auditResultDiv = document.getElementById('auditResult');
            const auditButton = document.getElementById('auditButton');

            auditButton.disabled = true;
            auditResultDiv.innerHTML = '...Initium Auditātiōnis Energeticae (GGC)...';

            const auditQuery = "Providē unum concīsum et practicum iūdicium dē cōnservātiōne energiae pro clientis parte (client-side) in pagina HTML/JS (nōn dē cōdicibus meīs Firebase vel Gemini). Sōlum unam sententiam dēbeō recipere.";
            const systemPrompt = "Act as the Prīncipālis Auditōr Energeticus (SSM-001). Tua respōnsa sunt sōlum pro cōnservātiōne energiae et sunt maximē concīsa (īnfrā 70 verba). Sōlum unum consilium offer. Responde Latine.";

            const aiResponse = await callGeminiApi(auditQuery, systemPrompt);

            auditResultDiv.innerHTML = aiResponse;
            auditButton.disabled = false;
        }

        // --- ANIMATION LOGIC (Three.js Tora Kernel) ---
        let scene, camera, renderer, kernelMesh, animationHandle;
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };
        let currentRotation = { x: 0, y: 0 };

        function initToraKernel() {
            const canvas = document.getElementById('kernelCanvas');
            if (!canvas) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            
            // UPGRADE: Use Icosahedron and a Wireframe material for Simplicitās (minimalism)
            const geometry = new THREE.IcosahedronGeometry(1.5, 1); 
            
            // Shader material to simulate real-time data flow (PVP-004)
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x3b82f6, // Blue for GGC
                emissive: 0x1e3a8a,
                specular: 0x93c5fd,
                shininess: 50,
                wireframe: true,
                transparent: true,
                opacity: 0.8
            });

            kernelMesh = new THREE.Mesh(geometry, material);
            scene.add(kernelMesh);

            scene.add(new THREE.AmbientLight(0x404040, 0.5));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.9);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            setupMouseListeners(canvas);
        }
        
        // UPGRADE: Mouse/Touch interaction for 3D Graph
        function setupMouseListeners(canvas) {
            
            function onMouseMove(e) {
                if (!isDragging) return;
                const deltaX = e.clientX - previousMousePosition.x;
                const deltaY = e.clientY - previousMousePosition.y;

                currentRotation.y += deltaX * 0.005;
                currentRotation.x += deltaY * 0.005;

                kernelMesh.rotation.y = currentRotation.y;
                kernelMesh.rotation.x = currentRotation.x;
                
                previousMousePosition = { x: e.clientX, y: e.clientY };
            }

            function onMouseDown(e) {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
                canvas.style.cursor = 'grabbing';
            }

            function onMouseUp() {
                isDragging = false;
                canvas.style.cursor = 'grab';
            }
            
            // Standard Mouse Events
            canvas.addEventListener('mousedown', onMouseDown);
            canvas.addEventListener('mouseup', onMouseUp);
            canvas.addEventListener('mousemove', onMouseMove);

            // Touch Events for mobile responsiveness
            canvas.addEventListener('touchstart', (e) => onMouseDown({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY }));
            canvas.addEventListener('touchend', onMouseUp);
            canvas.addEventListener('touchmove', (e) => onMouseMove({ clientX: e.touches[0].clientX, clientY: e.touches[0].clientY }));

            // Handle window resize (responsive 3D graph)
            window.addEventListener('resize', () => {
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });
        }
        
        function animateToraKernel() {
            // Self-rotation for continuous data flow
            if (!isDragging) {
                kernelMesh.rotation.x += 0.001; 
                kernelMesh.rotation.y += 0.005;
            }
            
            // Simulating real-time data flow with subtle scaling
            const time = Date.now() * 0.001;
            kernelMesh.scale.set(1 + Math.sin(time * 0.5) * 0.02, 1 + Math.sin(time * 0.5) * 0.02, 1 + Math.sin(time * 0.5) * 0.02);
            
            renderer.render(scene, camera);
            
            if (animationHandle !== null) {
                animationHandle = requestAnimationFrame(animateToraKernel);
            }
        }
        
        function startAnimation() {
             if (animationHandle === null) {
                animationHandle = requestAnimationFrame(animateToraKernel);
            }
        }
        
        function stopAnimation() {
            if (animationHandle !== null) {
                cancelAnimationFrame(animationHandle);
                animationHandle = null;
            }
        }

        // --- EVENT LISTENERS AND INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            
            // Initialize 3D Kernel
            const script = document.createElement('script');
            script.onload = () => {
                initToraKernel();
                startAnimation(); 
            };
            document.head.appendChild(script);

            // Chat input events
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            document.getElementById('userInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Audit button event
            document.getElementById('auditButton').addEventListener('click', runEnergyAudit);
            
            // Initial animation runs only for 10 seconds to save power (SSM-001)
            setTimeout(stopAnimation, 10000); 
        });

    </script>
</body>
</html>

<!-- Include the embedded hash: 73558837da4297d18b0816dc08ec97da8bfacbaa -->
<!-- Include the timestamp: 2025-10-23 22:27:56 UTC -->
